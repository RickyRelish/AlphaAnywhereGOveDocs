<%a5

'This file is automatically generated by Alpha Anywhere. Do not delete or edit.
dim action			as c = ""
dim c				as c = ""
dim csfilename		as c = ""
dim fileToDownload	as c = ""
dim folder			as c = ""
dim message			as c = ""
 
if eval_valid("Request.Variables.c") then
	c = Request.Variables.c
end if
if c <> "_a5filedownload" then
	end
end if
if eval_valid("Request.Variables.action") then
	action = Request.Variables.action
end if
if eval_valid("Request.Variables.message") then
	message = Request.Variables.message
end if
if eval_valid("Request.Variables.fileToDownload") then
	fileToDownload = Request.Variables.fileToDownload
end if


dim jwt as c 
if eval_valid("Request.Variables.token") then 
	jwt = Request.Variables.token
end if 

if jwt = "" then 
	end 
end if 

dim wpp2 as p
wpp2 = a5_getWebProjectProperties()
dim wpp as p
property_recurse_assign(wpp,wpp2)
dim wpp.__token as c = default "somerandomvalue" + cdate(date())
dim decodedToken as c 
decodedToken = jwt_decode(jwt,wpp.__token)
if decodedToken = "" then 
	end 
end if 

dim p as p
p = json_parse(decodedToken)
dim fn2 as c = p.filename 
if fn2 <> filetoDownload then 
	end 
end if 



'check to see if the filename is a JSON definition for a file in cloud storage
dim p as p
filetodownload = alltrim(filetodownload)
if left(filetodownload,1) = "{" then 
	p = json_parse(filetodownload)
	if eval_valid("p.cs") then 
		dim cs as c 
		cs = "::storage::" + p.cs
		dim fn as c 
		dim ext as c 
		ext = file.filename_parse(p.object,"e")
		dim flag as l 
		fn = request.GetRequestTempFileName(ext)
		dim pr as p
		flag = a5storage_getitem_as_file(cs,p.object,fn,pr)
		if flag = .t. then 
			dim key as c 
			key = "A5SessionFile__" + api_uuidcreate()
			key = key  + file.filename_parse(p.object,"e")
			Session.SaveDataAsFile(key,file.to_blob(fn))
			filetodownload = key 
		else
			filetodownload = "Error: S3 file '" + p.object + "'"
		end if 
	end if 
end if 
'---------------------------------------------


if eval_valid("Request.Variables.csfilename") then
	csfilename = Request.Variables.csfilename
end if
if eval_valid("Request.Variables.folder") then
	folder = Request.Variables.folder
	if folder <> "" then
		if atc("[",folder) > 0 then 
			folder = filename_decode(folder)
		end if 
	end if
end if

dim activeLanguage as c = "Default"
if eval_valid("request.variables.activeLanguage") then 
	activeLanguage = request.variables.activeLanguage
	if activeLanguage = "undefined" .or. activeLanguage = "<Default>" then 
		activeLanguage = "Default"
	end if 
	
end if 

if fileToDownload = "" then
	if action = "Display message" then
		dim js as c
		? "<script type=\"text/javascript\">alert('You did not specify the name of a file to download.');</script>"
		end
	end if
end if


if csfilename <> "" then 
	if file.filename_parse(csfilename,"e") = "" then 
		csfilename = csfilename + file.filename_parse(filetodownload,"e")
	end if 
end if 



if left(filetodownload,2) <> chr(92) + chr(92) then
	if file.filename_parse(fileToDownload,"d") = "" then
		if folder <> "" then
			if left(folder,2) <> chr(92) + chr(92) then
				folder = alltrim(folder)
				if atc("Session.",folder) = 1 then
					if eval_valid(folder) then
						folder = eval(folder)
					end if
				end if
				if eval_valid("session.session_folder") then
					'under IIS there is no session folder
					if atc("<UserSessionFolder>",folder) > 0  then
						folder = stritran(folder,"<UserSessionFolder>",Session.Session_Folder)
					end if
				end if 

				if file.filename_parse(folder,"d") = ""
					'user specified a relative path for the download folder
					folder = Request.ApplicationRoot + folder
				end if
			end if
			
			dim file2 as c = fileToDownload
			file2 = stritran(file2,"/",chr(92)) 

			fileToDownload = a5_removetrailingbackslash(folder) + chr(92) + fileToDownload
			
			if file.exists(filetodownload) = .f. then 
				fileToDownload = Request.ApplicationRoot + file2
			end if 
		end if
	end if
end if

dim flagUsingA5SessionFile as l = .f.

if atc("A5SessionFile__",fileToDownload) = 1 .or. atc("A5SessionFilePrefix__",fileToDownload) = 1  .or. atc("A5SessionFile/",filetodownload) = 1   then 
	flagUsingA5SessionFile = .t.
	dim key as c 
	key = fileToDownload
	
	if atc("A5SessionFilePrefix__",fileToDownload) = 1 then 
		key = word(key,2,"A5SessionFilePrefix__")
	end if 
	
	
	if atc("A5SessionFile/",fileToDownload) = 1 then 
		key = word(key,2,"A5SessionFile/")
	end if 
	
	dim ext as c 
	ext = file.filename_parse(key,"e")
	dim fnTemp as c 
	dim fnTempA as c
	fnTemp = request.GetRequestTempFileName(ext)
	fnTempA = convert_utf8_to_acp(fnTemp)
	
	'1/5/2015 - don't read the file into memory
	'dim b as b 
	'session.GetDataFromFile(b,key)
	'if typeof(b) = "c" then 
	'	file.from_string(fnTempA,b)
	'else
	'	file.from_blob(fnTempA,b)
	'end if 
	session.SaveSessionFileToFile(key,fnTemp)
	
	
	'protect against bug on Android browsers which request the file twice
	dim flagDeleteSessionFile as l = .t.
	if eval_valid("request.variables.deleteSessionFile") then 
		flagDeleteSessionFile = convert_type(request.variables.deleteSessionFile,"L")
	end if 
	
	if flagDeleteSessionFile then 
		session.DeleteSessionFile(key)
	end if 
	fileToDownload = fnTemp
end if
if atc("http://",fileToDownLoad) > 0 .or. atc("https://",filetodownload) > 0 then 
	dim fn as c 
	dim ext as c = file.filename_parse(filetodownload,"e")
	fn = a5_GetTempFilename(ext)
	dim p as p
	if atc("https://",filetodownload) > 0 then 
		dim flag as l
		flag =  curl_get_file(filetodownload,fn)
		if flag then 
			filetodownload = fn 
		end if 
	else
		p = http_get(filetodownload)
		if p.error_code = 0 then 
			dim b as b 
			b = p.body
			file.from_blob(fn,b)
			filetodownload = fn 
		
		end if 	
	end if 
	if eval_valid("csfilename") = .f. then 
		csfilename = file.filename_parse(filetodownload,"ne")
	else
		if csfilename = "" then 
			csfilename = file.filename_parse(filetodownload,"ne")
		end if 
	end if 
end if 


dim fileToDownloadACP as c 
if file.exists(fileToDownload) then
	'get the fully qualifield filename
	fileToDownload = file.fullname_get(fileToDownload)
	fileToDownloadAcp = fileToDownload
else	
	fileToDownloadAcp = convert_utf8_to_acp(fileToDownload)
end if	

if file.exists(fileToDownloadACP) then
	if left(filetodownload,2) <> chr(92) + chr(92) then
		if file.filename_parse(fileToDownload,"d") = "" then
			fileToDownLoad = Request.ApplicationRoot + fileToDownload
		end if
	end if
end if

if .not. file.exists(fileToDownloadACP) then
	if action = "Display message" then
		message = stritran(message,"{filename}",fileToDownload)
		message = stritran(message,"{shortfilename}",file.filename_parse(fileToDownload,"NE"))
		if atc("<a5:t>",message) > 0 then 
			message = A5GridHelper_textDictionaryResolver(message,activeLanguage)
		end if 
		
		? "<script type=\"text/javascript\">alert('"+js_escape(message,"U")+"');</script>"
	end if
	end
end if

dim actualFilename as c
actualFilename = fileToDownload

dim tempfile as c 
'test if filename contains international characters
if fileToDownloadACP <> filetodownload then 
	dim format as c 
	format = file.filename_parse(actualFilename,"e")
	tempfile = convert_utf8_to_acp(request.GetRequestTempFileName(format))	
	'file.copy( fileToDownloadACP, tempfile)
	system::io::file::Copy(fileToDownload,tempfile,.t.)
	if csfilename = "" then 
		csfilename = file.filename_parse(actualFilename,"ne")
	end if 
	
else
	tempfile = filetodownload
end if 


dim projProp as p
projProp = a5_getWebProjectProperties()

if a5_fileFilterTest(actualFilename,projProp,Session, flagUsingA5SessionFile)   then
	response.ClearContent()
	if csfilename = "" then 
		Response.SendFile(if(*utf8_valid(tempfile),tempfile,convert_acp_to_utf8(tempfile)))
	else
		Response.SendFile(if(*utf8_valid(tempfile),tempfile,convert_acp_to_utf8(tempfile)),if(*utf8_valid(csfilename),csfilename,convert_acp_to_utf8(csfilename)))
	end if 
	on error resume next
	Context.HostContext.Response.SuppressContent = .t. 
	response.end()
else
	dim permissionDeniedReason as c 
	permissionDeniedReason = projProp.permissionDeniedReason
	dim flagShowMsg as l = .t.
	if eval_valid("request.variables.displayPermissionDeniedMsg") then 
		flagShowMsg = convert_type(request.variables.displayPermissionDeniedMsg,"L")
	end if 
	
	if flagShowMsg then
		? "<script type=\"text/javascript\">alert('"+js_escape(permissionDeniedReason,"U")+"');</script>"
	end if 
	
end if

end
failed:



%>